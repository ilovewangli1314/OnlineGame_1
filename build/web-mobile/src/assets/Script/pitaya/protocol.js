(function(e,n,r){var o=e,t=o.Package={},f=o.Message={};t.TYPE_HANDSHAKE=1,t.TYPE_HANDSHAKE_ACK=2,t.TYPE_HEARTBEAT=3,t.TYPE_DATA=4,t.TYPE_KICK=5,f.TYPE_REQUEST=0,f.TYPE_NOTIFY=1,f.TYPE_RESPONSE=2,f.TYPE_PUSH=3,o.strencode=function(e){for(var r=new n(3*e.length),o=0,t=0;t<e.length;t++){var f=e.charCodeAt(t),i=null;i=f<=127?[f]:f<=2047?[192|f>>6,128|63&f]:[224|f>>12,128|(4032&f)>>6,128|63&f];for(var l=0;l<i.length;l++)r[o]=i[l],++o}var E=new n(o);return u(E,0,r,0,o),E},o.strdecode=function(e){for(var r=new n(e),o=[],t=0,f=0,u=r.length;t<u;)r[t]<128?(f=r[t],t+=1):r[t]<224?(f=((63&r[t])<<6)+(63&r[t+1]),t+=2):(f=((15&r[t])<<12)+((63&r[t+1])<<6)+(63&r[t+2]),t+=3),o.push(f);return String.fromCharCode.apply(null,o)},t.encode=function(e,r){var o=r?r.length:0,t=new n(4+o),f=0;return t[f++]=255&e,t[f++]=o>>16&255,t[f++]=o>>8&255,t[f++]=255&o,r&&u(t,f,r,0,o),t},t.decode=function(e){for(var r=0,o=new n(e),t=0,f=[];r<o.length;){var i=o[r++],l=(t=(o[r++]<<16|o[r++]<<8|o[r++])>>>0)?new n(t):null;u(l,0,o,r,t),r+=t,f.push({type:i,body:l})}return 1===f.length?f[0]:f},f.encode=function(e,r,t,f,u){var d=1+(i(r)?E(e):0);if(l(r))if(t){if("number"!=typeof f)throw new Error("error flag for number route!");d+=2}else if(d+=1,f){if((f=o.strencode(f)).length>255)throw new Error("route maxlength is overflow");d+=f.length}u&&(d+=u.length);var T=new n(d),P=0;return P=a(r,t,T,P),i(r)&&(P=w(e,T,P)),l(r)&&(P=h(t,f,T,P)),u&&(P=c(u,T,P)),T},f.decode=function(e){var r=new n(e),t=r.length||r.byteLength,f=0,E=0,a=null,w=r[f++],h=1&w,c=w>>1&7;if(i(c)){var d=parseInt(r[f]),T=0;do{E+=(127&(d=parseInt(r[f])))*Math.pow(2,7*T),f++,T++}while(d>=128)}if(l(c))if(h)a=r[f++]<<8|r[f++];else{var P=r[f++];P?(a=new n(P),u(a,0,r,f,P),a=o.strdecode(a)):a="",f+=P}var g=t-f,s=new n(g);return u(s,0,r,f,g),{id:E,type:c,compressRoute:h,route:a,body:s}};var u=function(e,n,r,o,t){if("function"==typeof r.copy)r.copy(e,n,o,o+t);else for(var f=0;f<t;f++)e[n++]=r[o++]},i=function(e){return e===f.TYPE_REQUEST||e===f.TYPE_RESPONSE},l=function(e){return e===f.TYPE_REQUEST||e===f.TYPE_NOTIFY||e===f.TYPE_PUSH},E=function(e){var n=0;do{n+=1,e>>=7}while(e>0);return n},a=function(e,n,r,o){if(e!==f.TYPE_REQUEST&&e!==f.TYPE_NOTIFY&&e!==f.TYPE_RESPONSE&&e!==f.TYPE_PUSH)throw new Error("unkonw message type: "+e);return r[o]=e<<1|(n?1:0),o+1},w=function(e,n,r){do{var o=e%128,t=Math.floor(e/128);0!==t&&(o+=128),n[r++]=o,e=t}while(0!==e);return r},h=function(e,n,r,o){if(e){if(n>65535)throw new Error("route number is overflow");r[o++]=n>>8&255,r[o++]=255&n}else n?(r[o++]=255&n.length,u(r,o,n,0,n.length),o+=n.length):r[o++]=0;return o},c=function(e,n,r){return u(n,r,e,0,e.length),r+e.length};"undefined"!=typeof window&&(window.Protocol=o)})("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array);