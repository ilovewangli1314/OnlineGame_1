(function(){function e(t){if(t)return function(t){for(var n in e.prototype)t[n]=e.prototype[n];return t}(t)}e.prototype.on=e.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},e.prototype.once=function(e,t){var n=this;function o(){n.off(e,o),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},o.fn=t,this.on(e,o),this},e.prototype.off=e.prototype.removeListener=e.prototype.removeAllListeners=e.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,o=this._callbacks[e];if(!o)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r=0;r<o.length;r++)if((n=o[r])===t||n.fn===t){o.splice(r,1);break}return this},e.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var o=0,r=(n=n.slice(0)).length;o<r;++o)n[o].apply(this,t);return this},e.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return!!this.listeners(e).length};var t=window.Protocol,n=t.Package,o=t.Message,r=e,i=window.rsa;"undefined"!=typeof window&&"undefined"!=typeof sys&&sys.localStorage&&(window.localStorage=sys.localStorage);"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var c=window,s=Object.create(r.prototype);c.starx=s;var a,l=null,u=0,f={},d={},p={},y={},h={},v=0,b=0,_=0,k=null,m=null,T=null,g=null,E=null,w=!1,A=null,S=null,P=0,Y=5e3,N={sys:{type:"js-websocket",version:"0.0.1",rsa:{}},user:{}},O=null;s.init=function(e,t){O=t;var n=e.host,o=e.port,r=e.path;E=e.encode||H,g=e.decode||D;var c="ws://"+n;if(o&&(c+=":"+o),r&&(c+=r),N.user=e.user,e.encrypt){a=!0,i.generate(1024,"10001");var s={rsa_n:i.n.toString(16),rsa_e:i.e};N.sys.rsa=s}T=e.handshakeCallback,K(e,c,t)};var D=s.decode=function(e){var t=o.decode(e);if(!(t.id>0)||(t.route=p[t.id],delete p[t.id],t.route))return t.body=B(t),t},H=s.encode=function(e,t,n){var r=e?o.TYPE_REQUEST:o.TYPE_NOTIFY,i=0;return y&&y[t]&&(t=y[t],i=1),o.encode(e,r,i,t,n)},K=function(e,o,r){console.log("connect to "+o);var i=(e=e||{}).maxReconnectAttempts||10;S=o;(l=new WebSocket(o)).binaryType="arraybuffer",l.onopen=function(e){w&&s.emit("reconnect"),J();var o=n.encode(n.TYPE_HANDSHAKE,t.strencode(JSON.stringify(N)));R(o)},l.onmessage=function(e){x(n.decode(e.data),r),b&&(_=Date.now()+b)},l.onerror=function(e){s.emit("io-error",e),console.error("socket error: ",e)},l.onclose=function(t){s.emit("close",t),s.emit("disconnect",t),console.log("socket close: ",t),e.reconnect&&P<i&&(w=!0,P++,A=setTimeout(function(){K(e,S,r)},Y),Y*=2)}};s.disconnect=function(){l&&(l.disconnect&&l.disconnect(),l.close&&l.close(),console.log("disconnect"),l=null),k&&(clearTimeout(k),k=null),m&&(clearTimeout(m),m=null)};var J=function(){w=!1,Y=5e3,P=0,clearTimeout(A)};s.request=function(e,t,n){2===arguments.length&&"function"==typeof t?(n=t,t={}):t=t||{},(e=e||t.route)&&(L(++u,e,t),f[u]=n,p[u]=e)},s.notify=function(e,t){L(0,e,t=t||{})};var L=function(e,t,o){if(a){o=JSON.stringify(o);var r=i.signString(o,"sha256");(o=JSON.parse(o)).__crypto__=r}E&&(o=E(e,t,o));var c=n.encode(n.TYPE_DATA,o);R(c)},R=function(e){l.send(e.buffer)},j=function(){var e=_-Date.now();e>100?m=setTimeout(j,e):(console.error("server heartbeat timeout"),s.emit("heartbeat timeout"),s.disconnect())};d[n.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(t.strdecode(e))).code)if(200===e.code){I(e);var o=n.encode(n.TYPE_HANDSHAKE_ACK);R(o),O&&O(l)}else s.emit("error","handshake fail");else s.emit("error","client version not fullfill")},d[n.TYPE_HEARTBEAT]=function(e){if(v){var t=n.encode(n.TYPE_HEARTBEAT);m&&(clearTimeout(m),m=null),k||(k=setTimeout(function(){k=null,R(t),_=Date.now()+b,m=setTimeout(j,b)},v))}},d[n.TYPE_DATA]=function(e){var t=e;g&&(t=g(t)),C(s,t)},d[n.TYPE_KICK]=function(e){e=JSON.parse(t.strdecode(e)),s.emit("onKick",e)};var x=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];d[n.type](n.body)}else d[e.type](e.body)},C=function(e,t){if(t.id){var n=f[t.id];delete f[t.id],"function"==typeof n&&n(t.body)}else e.emit(t.route,t.body)},B=function(e){var t=e.route;if(e.compressRoute){if(!h[t])return{};t=e.route=h[t]}return e.body},I=function(e){e.sys&&e.sys.heartbeat?(v=1e3*e.sys.heartbeat,b=2*v):(v=0,b=0),q(e),"function"==typeof T&&T(e.user)},q=function(e){if(e&&e.sys){if(y=e.sys.dict)for(var t in h={},y=y)h[y[t]]=t;window.starx=s}}})();